<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WordBox 2 Joueurs</title>
    <style>
        /* COLLE TOUT TON CSS ICI */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: sans-serif; }
        body { background: #1a202c; min-height: 100vh; padding: 20px; }
        .game-container { background: white; border-radius: 20px; padding: 30px; max-width: 900px; margin: auto; }
        h1 { color: #4a5568; text-align: center; margin-bottom: 20px; }
        /* ... AJOUTE TOUT LE RESTE DE TON CSS ORIGINAL ... */
    </style>
</head>
<body>
    <div class="game-container">
        <!-- √âcran Lobby -->
        <div id="lobby">
            <h1>WORD BOX 2 JOUEURS</h1>
            <button onclick="createGame()" style="padding: 15px; margin: 10px; font-size: 18px;">
                Cr√©er une partie
            </button>
            <br>
            <input id="gameCodeInput" placeholder="Code de partie" style="padding: 10px; font-size: 16px;">
            <div id="gameCodeDisplay" style="
                margin: 15px;
                padding: 10px;
                background: #e8f4fd;
                border-radius: 8px;
                display: none;
            "></div>
            <button onclick="joinGame()" style="padding: 15px; margin: 10px; font-size: 18px;">
                Rejoindre
            </button>
        </div>
        
        <!-- √âcran Jeu -->
        <div id="gameScreen" style="display: none;">
            <h1>WORD BOX</h1>
            <div style="display: flex; justify-content: space-between; margin: 20px 0;">
                <div id="player1">Joueur 1: <span id="score1">0</span></div>
                <div id="timer">‚è±Ô∏è <span id="time">02:00</span></div>
                <div id="player2">Joueur 2: <span id="score2">0</span></div>
            </div>
            
            <div id="currentWord" style="font-size: 24px; text-align: center; margin: 20px; min-height: 40px;">
                Glissez sur les lettres...
            </div>
            
            <!-- Grille 5x5 -->
            <div id="grid" style="
                display: grid;
                grid-template-columns: repeat(5, 60px);
                grid-gap: 10px;
                justify-content: center;
                margin: 20px;
            ">
                <!-- Les lettres seront ajout√©es par JavaScript -->
            </div>
            
            <!-- Apr√®s la grille -->
            <div id="foundWords" style="
                max-height: 200px;
                overflow-y: auto;
                margin: 20px;
                padding: 10px;
                border: 1px solid #ccc;
                border-radius: 10px;
            ">
                <!-- Les mots appara√Ætront ici -->
            </div>

            <div style="display: flex; justify-content: space-between; margin: 20px 0; font-size: 20px;">
                <div>üë§ Vous: <span id="score1">0</span></div>
                <div>‚è±Ô∏è <span id="time">02:00</span></div>
                <div>üë• Adversaire: <span id="score2">0</span></div>
            </div>
        </div>
        <!-- √âcran de fin -->
        <div id="endScreen" style="display: none; text-align: center; padding: 40px;">
            <h1>üèÜ Partie Termin√©e!</h1>
            <div id="finalScores" style="font-size: 24px; margin: 30px;">
                <!-- Scores finaux -->
            </div>
            <div style="display: flex; gap: 40px; justify-content: center; margin: 40px;">
                <div style="flex: 1;">
                    <h3>Vos mots</h3>
                    <div id="myFinalWords" style="text-align: left; max-height: 300px; overflow-y: auto;"></div>
                </div>
                <div style="flex: 1;">
                    <h3>Mots adversaire</h3>
                    <div id="opponentFinalWords" style="text-align: left; max-height: 300px; overflow-y: auto;"></div>
                </div>
            </div>
            <button onclick="backToLobby()" style="padding: 15px 30px; font-size: 18px; margin-top: 20px;">
                Retour au lobby
            </button>
        </div>
    </div>
    <script>
        // Variables globales
let gameId = '';
let playerId = '';
let playerNumber = '';
let grid = [];
let selectedCells = [];
let isDragging = false;
let gameState = null;
let pollInterval = null;

// Cr√©er une partie
async function createGame() {
    try {
        const response = await fetch('/api/game', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'create' })
        });
        
        const data = await response.json();
        
        if (data.success) {
            gameId = data.gameId;
            grid = data.grid;
            
            if (document.getElementById('gameCodeDisplay')) {
    document.getElementById('gameCodeDisplay').textContent = `Code: ${gameId}`;
    document.getElementById('gameCodeDisplay').style.display = 'block';
}
            document.getElementById('gameCodeDisplay').style.display = 'block';
            
            // Auto-rejoindre comme joueur 1
            await joinGame(gameId);
        }
    } catch (error) {
        alert('Erreur cr√©ation partie');
    }
}

// Rejoindre une partie
async function joinGame(code) {
    const gameCode = code || document.getElementById('gameCodeInput').value;
    if (!gameCode) return alert('Entrez un code');
    
    try {
        const response = await fetch('/api/game', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                action: 'join', 
                gameId: gameCode 
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            gameId = gameCode;
            playerId = data.playerId;
            playerNumber = data.playerNumber;
            grid = data.grid || grid;
            
            alert(`Vous √™tes Joueur ${playerNumber}`);
            
            // Si la partie est active (2 joueurs), d√©marrer
            if (data.gameActive) {
                startGame();
            } else {
                // Attendre le 2√®me joueur
                waitForSecondPlayer();
            }
        } else {
            alert(data.error);
        }
    } catch (error) {
        alert('Partie non trouv√©e');
    }
}

// Attendre le 2√®me joueur
function waitForSecondPlayer() {
    const checkInterval = setInterval(async () => {
        const response = await fetch('/api/game', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                action: 'get', 
                gameId: gameId 
            })
        });
        
        const data = await response.json();
        
        if (data.gameState && data.gameState.gameActive) {
            clearInterval(checkInterval);
            startGame();
        }
    }, 2000);
}

// D√©marrer le jeu
function startGame() {
    // Cacher lobby, montrer jeu
    document.getElementById('lobby').style.display = 'none';
    document.getElementById('gameScreen').style.display = 'block';
    
    // Cr√©er la grille
    createGrid();
    
    // D√©marrer le polling pour les mises √† jour
    startPolling();
    
    // Setup drag & drop
    setupDragAndDrop();
}

// Cr√©er la grille visuelle
function createGrid() {
    const gridContainer = document.getElementById('grid');
    gridContainer.innerHTML = '';
    
    grid.forEach((letter, index) => {
        const cell = document.createElement('div');
        cell.className = 'letter-cell';
        cell.dataset.index = index;
        cell.textContent = letter;
        
        // Style de la cellule
        cell.style.cssText = `
            width: 60px;
            height: 60px;
            background: white;
            border: 2px solid #cbd5e0;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            user-select: none;
            transition: all 0.2s;
        `;
        
        gridContainer.appendChild(cell);
    });
}

// Setup drag & drop
function setupDragAndDrop() {
    const gridContainer = document.getElementById('grid');
    let startCell = null;
    
    // D√©marrer le drag
    gridContainer.addEventListener('mousedown', (e) => {
        if (!isMyTurn()) return;
        
        const cell = e.target.closest('.letter-cell');
        if (!cell) return;
        
        isDragging = true;
        startCell = cell;
        selectedCells = [parseInt(cell.dataset.index)];
        updateVisualSelection();
        e.preventDefault();
    });
    
    gridContainer.addEventListener('touchstart', (e) => {
        if (!isMyTurn()) return;
        
        const touch = e.touches[0];
        const cell = document.elementFromPoint(touch.clientX, touch.clientY);
        if (!cell || !cell.classList.contains('letter-cell')) return;
        
        isDragging = true;
        startCell = cell;
        selectedCells = [parseInt(cell.dataset.index)];
        updateVisualSelection();
        e.preventDefault();
    });
    
    // Pendant le drag
    document.addEventListener('mousemove', (e) => {
        if (!isDragging || !isMyTurn()) return;
        
        const cell = document.elementFromPoint(e.clientX, e.clientY);
        if (!cell || !cell.classList.contains('letter-cell')) return;
        
        const cellIndex = parseInt(cell.dataset.index);
        
        // V√©rifier si adjacente √† la derni√®re cellule
        if (!selectedCells.includes(cellIndex) && isAdjacent(cellIndex)) {
            selectedCells.push(cellIndex);
            updateVisualSelection();
        }
    });
    
    document.addEventListener('touchmove', (e) => {
        if (!isDragging || !isMyTurn()) return;
        
        const touch = e.touches[0];
        const cell = document.elementFromPoint(touch.clientX, touch.clientY);
        if (!cell || !cell.classList.contains('letter-cell')) return;
        
        const cellIndex = parseInt(cell.dataset.index);
        
        if (!selectedCells.includes(cellIndex) && isAdjacent(cellIndex)) {
            selectedCells.push(cellIndex);
            updateVisualSelection();
        }
        
        e.preventDefault();
    });
    
    // Fin du drag (validation automatique)
    document.addEventListener('mouseup', async () => {
        if (!isDragging || !isMyTurn()) return;
        
        isDragging = false;
        
        if (selectedCells.length >= 3) {
            await submitWord();
        }
        
        selectedCells = [];
        updateVisualSelection();
    });
    
    document.addEventListener('touchend', async () => {
        if (!isDragging || !isMyTurn()) return;
        
        isDragging = false;
        
        if (selectedCells.length >= 3) {
            await submitWord();
        }
        
        selectedCells = [];
        updateVisualSelection();
    });
}

// V√©rifier si une cellule est adjacente √† la derni√®re s√©lectionn√©e
function isAdjacent(cellIndex) {
    if (selectedCells.length === 0) return true;
    
    const lastIndex = selectedCells[selectedCells.length - 1];
    const lastRow = Math.floor(lastIndex / 5);
    const lastCol = lastIndex % 5;
    const newRow = Math.floor(cellIndex / 5);
    const newCol = cellIndex % 5;
    
    return Math.abs(newRow - lastRow) <= 1 && Math.abs(newCol - lastCol) <= 1;
}

// Mettre √† jour la s√©lection visuelle
function updateVisualSelection() {
    document.querySelectorAll('.letter-cell').forEach((cell, index) => {
        if (selectedCells.includes(index)) {
            cell.style.background = '#bee3f8';
            cell.style.transform = 'scale(1.1)';
        } else {
            cell.style.background = 'white';
            cell.style.transform = 'scale(1)';
        }
    });
    
    // Afficher le mot en cours
    const currentWord = selectedCells.map(idx => grid[idx]).join('');
    document.getElementById('currentWord').textContent = 
        currentWord || 'Glissez sur les lettres...';
}

// Soumettre un mot
async function submitWord() {
    const word = selectedCells.map(idx => grid[idx]).join('');
    
    try {
        const response = await fetch('/api/game', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: 'submit',
                gameId: gameId,
                playerId: playerId,
                word: word
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Le polling mettra √† jour l'interface
        } else {
            alert(data.error);
        }
    } catch (error) {
        console.error('Erreur soumission:', error);
    }
}

// Polling pour les mises √† jour
function startPolling() {
    pollInterval = setInterval(async () => {
        try {
            const response = await fetch('/api/game', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action: 'get',
                    gameId: gameId
                })
            });
            
            const data = await response.json();
            
            if (data.gameState) {
                gameState = data.gameState;
                updateGameInterface();
                
                // V√©rifier fin de partie
                if (!gameState.gameActive) {
                    clearInterval(pollInterval);
                    endGame();
                }
            }
        } catch (error) {
            console.error('Erreur polling:', error);
        }
    }, 1000);
}

// Mettre √† jour l'interface
function updateGameInterface() {
    if (!gameState) return;
    
    // Scores
    document.getElementById('score1').textContent = gameState.scores['1'];
    document.getElementById('score2').textContent = gameState.scores['2'];
    
    // Timer
    const minutes = Math.floor(gameState.timeLeft / 60);
    const seconds = gameState.timeLeft % 60;
    document.getElementById('time').textContent = 
        `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
    
    // Pas d'indicateur de tour (mode simultan√©)
    // Les deux joueurs peuvent jouer en m√™me temps
    
    // Mots trouv√©s
    updateFoundWords();
}

// Mettre √† jour la liste des mots
function updateFoundWords() {
    const container = document.getElementById('foundWords');
    container.innerHTML = '<h4>Vos mots trouv√©s:</h4>';
    
    // Afficher seulement SES propres mots pendant la partie
    if (gameState && gameState.foundWords) {
        const myWords = gameState.foundWords[playerNumber] || [];
        
        myWords.forEach(word => {
            const el = document.createElement('div');
            el.textContent = word;
            el.style.cssText = `
                padding: 8px 12px;
                background: #bee3f8;
                margin: 4px;
                border-radius: 8px;
                font-weight: bold;
            `;
            container.appendChild(el);
        });
        
        if (myWords.length === 0) {
            container.innerHTML += '<div style="color: #999; font-style: italic;">Aucun mot encore...</div>';
        }
    }
}

function isMyTurn() {
    // Mode simultan√© : toujours vrai si la partie est active
    return gameState && gameState.gameActive;
}

// Fin de partie
function endGame() {
    // Cacher l'√©cran de jeu
    document.getElementById('gameScreen').style.display = 'none';
    
    // Afficher l'√©cran de fin
    document.getElementById('endScreen').style.display = 'block';
    
    // Afficher les scores finaux
    const myScore = gameState.scores[playerNumber];
    const opponentNum = playerNumber === '1' ? '2' : '1';
    const opponentScore = gameState.scores[opponentNum];
    
    let winnerText = '';
    if (myScore > opponentScore) winnerText = 'üéâ Vous gagnez!';
    else if (opponentScore > myScore) winnerText = 'üòî L\'adversaire gagne';
    else winnerText = 'ü§ù Match nul';
    
    document.getElementById('finalScores').innerHTML = `
        <div>${winnerText}</div>
        <div style="font-size: 18px; margin-top: 10px;">
            Vous: ${myScore} pts | Adversaire: ${opponentScore} pts
        </div>
    `;
    
    // Afficher TOUS les mots
    displayAllWords();
}

function displayAllWords() {
    const myWords = gameState.foundWords[playerNumber] || [];
    const opponentNum = playerNumber === '1' ? '2' : '1';
    const opponentWords = gameState.foundWords[opponentNum] || [];
    
    const myContainer = document.getElementById('myFinalWords');
    const opponentContainer = document.getElementById('opponentFinalWords');
    
    myContainer.innerHTML = '';
    opponentContainer.innerHTML = '';
    
    // Vos mots
    myWords.forEach(word => {
        const el = document.createElement('div');
        el.textContent = word;
        el.style.cssText = 'padding: 6px; background: #bee3f8; margin: 3px; border-radius: 5px;';
        myContainer.appendChild(el);
    });
    
    if (myWords.length === 0) {
        myContainer.innerHTML = '<div style="color: #999; font-style: italic;">Aucun mot</div>';
    }
    
    // Mots adversaire
    opponentWords.forEach(word => {
        const el = document.createElement('div');
        el.textContent = word;
        el.style.cssText = 'padding: 6px; background: #fbd38d; margin: 3px; border-radius: 5px;';
        opponentContainer.appendChild(el);
    });
    
    if (opponentWords.length === 0) {
        opponentContainer.innerHTML = '<div style="color: #999; font-style: italic;">Aucun mot</div>';
    }
}

function backToLobby() {
    document.getElementById('endScreen').style.display = 'none';
    document.getElementById('lobby').style.display = 'block';
    
    // R√©initialiser
    gameId = '';
    playerId = '';
    playerNumber = '';
    selectedCells = [];
    clearInterval(pollInterval);
}
    </script>
</body>
</html>
